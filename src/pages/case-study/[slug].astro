---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import { getPageBreadcrumbSchema } from '../../utils/schemas';
import { caseStudies } from '../../data/caseStudies.js';

// Générer les chemins statiques pour toutes les case studies
export async function getStaticPaths() {
	return caseStudies.map((caseStudy) => ({
		params: { slug: caseStudy.slug }
	}));
}

const { slug } = Astro.params;

// Trouver la case study par slug
const caseStudy = caseStudies.find(cs => cs.slug === slug);

if (!caseStudy) {
	return Astro.redirect('/case-studies');
}

const title = `${caseStudy.title} | Julien Brionne`;
const description = caseStudy.description;

const siteUrl = typeof Astro.site === 'string' ? Astro.site : Astro.site?.href || "https://julien-brionne.fr";
const pageUrl = new URL(`/case-study/${slug}`, siteUrl).href;

// JSON-LD Schema pour Article
const articleSchema = {
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": caseStudy.title,
	"description": description,
	"author": {
		"@type": "Person",
		"name": "Julien Brionne"
	},
	"publisher": {
		"@type": "Organization",
		"name": "Product Copilot"
	},
	"datePublished": "2024-01-01",
	"dateModified": new Date().toISOString().split('T')[0],
	"url": pageUrl,
	"mainEntityOfPage": {
		"@type": "WebPage",
		"@id": pageUrl
	}
};

// Breadcrumb Schema
const breadcrumbSchema = getPageBreadcrumbSchema(siteUrl, pageUrl, caseStudy.title);
---

<Layout title={title} description={description}>
	<script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
	<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
	
	<Navbar />
	<main>
		
		<!-- SECTION 1 — HERO -->
		<section class="pt-32 md:pt-40 pb-24 md:pb-28 px-6 md:px-12 bg-ivory dark:bg-graphite relative" aria-label="Hero - Case Study">
			<div class="max-w-4xl mx-auto text-center space-y-6 fade-in-up">
				<p class="font-sans text-xs md:text-sm tracking-[0.15em] uppercase text-graphite dark:text-ivory font-semibold inline-block border border-sand/40 dark:border-sand/30 px-4 py-2">
					{caseStudy.label}
				</p>
				<h1 class="font-serif text-4xl md:text-5xl lg:text-6xl leading-[1.1] text-balance font-medium text-graphite dark:text-ivory">
					{caseStudy.title}
				</h1>
				<p class="font-serif text-lg md:text-xl italic text-graphite dark:text-warmgray-300 max-w-2xl mx-auto leading-relaxed">
					{caseStudy.heroIntro}
				</p>
			</div>
		</section>

		<!-- SECTION 2 — Le Diagnostic -->
		<section class="py-24 md:py-28 px-6 md:px-12 bg-[#f8f6f2] dark:bg-graphite-light relative z-10" aria-labelledby="diagnostic-heading">
			<div class="max-w-6xl mx-auto">
				<h2 id="diagnostic-heading" class="font-serif text-2xl md:text-3xl text-graphite dark:text-ivory mb-12 text-center">
					{caseStudy.problem.title}
				</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-16">
					<!-- Colonne gauche — Le Problème -->
					<div class="fade-in-up">
						<h3 class="font-sans text-sm md:text-base tracking-[0.1em] uppercase text-graphite dark:text-ivory mb-6 font-semibold">
							Le Problème
						</h3>
						<p class="font-sans text-base md:text-lg leading-relaxed text-graphite dark:text-warmgray-300">
							{caseStudy.problem.text}
						</p>
					</div>
					<!-- Colonne droite — L'Insight Clé -->
					<div class="fade-in-up border-l border-sand/40 dark:border-sand/30 pl-8 md:pl-12" style="transition-delay: 0.1s;">
						<h3 class="font-sans text-sm md:text-base tracking-[0.1em] uppercase text-graphite dark:text-ivory mb-6 font-semibold">
							{caseStudy.insight.title}
						</h3>
						<p class="font-sans text-base md:text-lg leading-relaxed text-graphite dark:text-warmgray-300">
							{caseStudy.insight.text}
						</p>
					</div>
				</div>
			</div>
		</section>

		<!-- SECTION 3 — Le Pivot Stratégique -->
		<section class="py-24 md:py-28 px-6 md:px-12 bg-ivory dark:bg-graphite relative z-10" aria-labelledby="strategy-heading">
			<div class="max-w-4xl mx-auto">
				<div class="space-y-8 fade-in-up">
					<h2 id="strategy-heading" class="font-serif text-3xl md:text-4xl lg:text-5xl text-graphite dark:text-ivory">
						{caseStudy.pivot.title}
					</h2>
					<p class="font-sans text-base md:text-lg leading-relaxed text-graphite dark:text-warmgray-300">
						{caseStudy.pivot.text}
					</p>
					<div class="border-l-2 border-sand/50 dark:border-sand/40 bg-[#F9F6F1] dark:bg-graphite-light p-8 md:p-10 mt-8">
						<p class="font-serif text-xl md:text-2xl italic text-graphite dark:text-ivory leading-relaxed">
							"{caseStudy.pivot.quote}"
						</p>
					</div>
				</div>
			</div>
		</section>

		<!-- SECTION 4 — Objectif / OKR -->
		<section class="py-24 md:py-28 px-6 md:px-12 bg-ivory dark:bg-graphite-light relative z-10" aria-labelledby="okr-heading">
			<div class="absolute inset-0 bg-sand/5 pointer-events-none"></div>
			<div class="max-w-6xl mx-auto relative z-10">
				<h2 id="okr-heading" class="font-serif text-3xl md:text-4xl lg:text-5xl text-graphite dark:text-ivory mb-12 text-center">
					{caseStudy.okr.title}
				</h2>
				{caseStudy.okr.intro && (
					<p class="font-sans text-base md:text-lg leading-relaxed text-graphite dark:text-warmgray-300 mb-12 text-center max-w-3xl mx-auto">
						{caseStudy.okr.intro}
					</p>
				)}
				<div class={`grid grid-cols-1 ${caseStudy.okr.krs.length === 3 ? 'md:grid-cols-2 lg:grid-cols-3' : 'md:grid-cols-2'} gap-12 md:gap-16`}>
					{caseStudy.okr.krs.map((kr, index) => (
						<div class="fade-in-up" style={`transition-delay: ${0.1 * index}s`}>
							<h3 class="font-serif text-xl md:text-2xl text-sand dark:text-sand-light mb-4 font-medium">
								{kr.title}
							</h3>
							<p class="font-sans text-base md:text-lg leading-relaxed text-graphite dark:text-warmgray-300 whitespace-pre-line">
								{kr.text}
							</p>
						</div>
					))}
				</div>
			</div>
		</section>

		<!-- SECTION 5 — L'Exécution -->
		<section class="py-24 md:py-28 px-6 md:px-12 bg-ivory dark:bg-graphite relative z-10" aria-labelledby="execution-heading">
			<div class="max-w-5xl mx-auto">
				<div class="space-y-8 fade-in-up">
					<h2 id="execution-heading" class="font-serif text-3xl md:text-4xl lg:text-5xl text-graphite dark:text-ivory">
						{caseStudy.experiments.title}
					</h2>
					{caseStudy.experiments.intro && (
						<p class="font-sans text-base md:text-lg leading-relaxed text-graphite dark:text-warmgray-300">
							{caseStudy.experiments.intro}
						</p>
					)}
					<div class="space-y-6 mt-12">
						{caseStudy.experiments.list.map((exp, index) => (
							<div class="border-l border-sand/50 dark:border-sand/40 pl-6 md:pl-8 py-4 fade-in-up" style={`transition-delay: ${0.1 * (index + 1)}s`}>
								<h3 class="font-sans text-lg md:text-xl font-semibold text-graphite dark:text-ivory mb-2">
									{exp.title}
								</h3>
								{exp.text && (
									<p class="font-sans text-base md:text-lg leading-relaxed text-graphite dark:text-warmgray-300">
										{exp.text}
									</p>
								)}
							</div>
						))}
					</div>
				</div>
			</div>
		</section>

		<!-- SECTION 6 — Résultats (fond noir premium) -->
		<section class="py-24 md:py-28 px-6 md:px-12 bg-graphite relative z-10" aria-labelledby="results-heading">
			<div class="max-w-5xl mx-auto">
				<div class="text-center space-y-12 fade-in-up">
					<h2 id="results-heading" class="font-serif text-4xl md:text-5xl lg:text-6xl text-sand leading-tight">
						{caseStudy.results.title}
					</h2>
					<p class="font-sans text-lg md:text-xl leading-relaxed text-warmgray-300 max-w-3xl mx-auto">
						{caseStudy.results.text}
					</p>
					<div class={`grid ${caseStudy.results.metrics.length === 1 ? 'grid-cols-1 max-w-md mx-auto' : 'grid-cols-1 md:grid-cols-2'} gap-12 md:gap-16 pt-8`}>
						{caseStudy.results.metrics.map((metric, index) => (
							<div class="fade-in-up" style={`transition-delay: ${0.1 * (index + 1)}s`}>
								<div class="font-serif text-5xl md:text-6xl text-sand mb-4">
									{metric.value}
								</div>
								<p class="font-sans text-lg md:text-xl text-warmgray-300">
									{metric.label}
								</p>
							</div>
						))}
					</div>
					<div class="pt-12">
						<a href="https://app.lemcal.com/@productcopilot/decouverte" 
						   data-lemcal-popup
						   class="inline-flex items-center gap-2 font-sans text-base md:text-lg text-sand hover:text-sand-light transition-colors duration-300 group"
						   aria-label={caseStudy.results.ctaText}>
							{caseStudy.results.ctaText}
							<svg class="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
							</svg>
						</a>
					</div>
				</div>
			</div>
		</section>

		<!-- SECTION 7 — CTA Final -->
		<section id="contact" class="py-32 px-6 md:px-12 flex flex-col justify-center items-center text-center relative z-0 bg-ivory dark:bg-graphite-light fade-in-up" aria-labelledby="cta-heading">
			<div class="absolute inset-0 bg-sand/5 pointer-events-none"></div>
			<div class="max-w-3xl space-y-6 relative z-10">
				<h2 id="cta-heading" class="font-serif text-3xl md:text-4xl leading-tight text-graphite dark:text-ivory">
					Votre produit traverse un moment critique.
				</h2>
				<p class="font-serif text-lg italic opacity-80 text-graphite dark:text-warmgray-300">
					Clarifions ensemble ce qui bloque.
				</p>
				<p class="text-base text-graphite dark:text-warmgray-300">
					Un échange de 30 minutes pour comprendre votre situation et identifier les leviers immédiats.
				</p>
				<div class="flex flex-col items-center gap-6 pt-4">
					<a href="https://app.lemcal.com/@productcopilot/decouverte" 
					   data-lemcal-popup
					   class="inline-block bg-graphite dark:bg-ivory text-ivory dark:text-graphite font-sans px-10 py-5 text-sm font-medium tracking-wide btn-premium"
					   aria-label="Diagnostiquer votre situation produit">
						Diagnostiquer votre situation
					</a>
					<div class="w-16 h-0.5 bg-sand mx-auto opacity-40"></div>
				</div>
			</div>
		</section>

	</main>
	<Footer />
</Layout>


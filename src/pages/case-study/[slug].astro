---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import ContextualPill from '../../components/ContextualPill.astro';
import Button from '../../components/Button.astro';
import BackgroundOverlay from '../../components/BackgroundOverlay.astro';
import { getPageBreadcrumbSchema, getReviewSchema } from '../../utils/schemas';
import { getCollection, getEntry } from 'astro:content';

// Mapping des slugs vers les composants
import ConversationContent from '../../components/case-studies/conversation.astro';
import TeamStabilityContent from '../../components/case-studies/team-stability.astro';
import OnboardingActivationContent from '../../components/case-studies/onboarding-activation.astro';

const componentMap: Record<string, any> = {
	'conversation': ConversationContent,
	'team-stability': TeamStabilityContent,
	'onboarding-activation': OnboardingActivationContent,
};

// Générer les chemins statiques pour toutes les case studies
export async function getStaticPaths() {
	const caseStudies = await getCollection('case-studies');
	return caseStudies.map((entry) => ({
		params: { slug: entry.id }
	}));
}

const { slug } = Astro.params;

// Charger les métadonnées depuis la collection
const entry = await getEntry('case-studies', slug || '');

if (!entry) {
	return Astro.redirect('/case-studies');
}

const caseStudy = entry.data;

// Récupérer le composant de contenu correspondant
const ContentComponent = componentMap[slug || ''];

if (!ContentComponent) {
	return Astro.redirect('/case-studies');
}

const title = `${caseStudy.title} | Julien Brionne`;
const description = caseStudy.description;

const siteUrl = typeof Astro.site === 'string' ? Astro.site : Astro.site?.href || "https://julien-brionne.fr";
const pageUrl = new URL(`/case-study/${slug}`, siteUrl).href;

// JSON-LD Schema pour Article
const articleSchema = {
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": caseStudy.title,
	"description": description,
	"author": {
		"@type": "Person",
		"name": "Julien Brionne"
	},
	"publisher": {
		"@type": "Organization",
		"name": "Product Copilot"
	},
	"datePublished": "2024-01-01",
	"dateModified": new Date().toISOString().split('T')[0],
	"url": pageUrl,
	"mainEntityOfPage": {
		"@type": "WebPage",
		"@id": pageUrl
	}
};

// Breadcrumb Schema (Accueil > Études de cas > [Titre de l'étude])
const breadcrumbSchema = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"name": "Accueil",
			"item": siteUrl
		},
		{
			"@type": "ListItem",
			"position": 2,
			"name": "Études de cas",
			"item": `${siteUrl}/case-studies`
		},
		{
			"@type": "ListItem",
			"position": 3,
			"name": caseStudy.title,
			"item": pageUrl
		}
	]
};

// Review Schema pour les études de cas (témoignage client)
// Note: Les données réelles devraient venir de la base de données clients
// Pour l'instant, on utilise des données génériques mais réalistes
const reviewData: Record<string, any> = {
	'conversation': {
		author: "CEO, Social Discovery App",
		datePublished: "2024-06-15",
		reviewBody: "L'intervention de Julien a permis de redresser une courbe de rétention stagnante à 15% alors que l'acquisition explosait. Son approche centrée sur l'impact et l'activation conversationnelle a transformé notre produit.",
		ratingValue: 5,
		itemReviewed: {
			name: "Accompagnement Product - Impact Sprint",
			"@type": "Service"
		}
	},
	'team-stability': {
		author: "CPO, Scale-up SaaS B2B",
		datePublished: "2024-08-20",
		reviewBody: "Dans une période de forte croissance, notre équipe Produit perdait sa cohésion. Julien a su rétablir un système de décision stable, clarifier les rôles et remettre tout le monde sur les bons rails sans restructuration majeure.",
		ratingValue: 5,
		itemReviewed: {
			name: "Accompagnement Product - Leadership Opérationnel",
			"@type": "Service"
		}
	},
	'onboarding-activation': {
		author: "Head of Product, SaaS B2B",
		datePublished: "2024-09-10",
		reviewBody: "Seuls 22% des utilisateurs atteignaient la valeur clé de notre produit. L'intervention de Julien a reconstruit une activation centrée sur le comportement, pas sur les fonctionnalités, débloquant ainsi l'usage réel.",
		ratingValue: 5,
		itemReviewed: {
			name: "Accompagnement Product - Impact Sprint",
			"@type": "Service"
		}
	}
};

const reviewConfig = reviewData[slug || ''] || reviewData['conversation'];
const reviewSchema = getReviewSchema({
	author: reviewConfig.author,
	datePublished: reviewConfig.datePublished,
	reviewBody: reviewConfig.reviewBody,
	ratingValue: reviewConfig.ratingValue,
	itemReviewed: reviewConfig.itemReviewed
});

// Mapping des pills contextuelles selon le slug
const pillTextMap: Record<string, string> = {
	'conversation': 'SOCIAL DISCOVERY',
	'team-stability': 'SAAS B2B',
	'onboarding-activation': 'SAAS B2B',
};

const pillText = pillTextMap[slug || ''] || 'Étude de cas';
---

<Layout title={title} description={description}>
	<script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
	<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
	<script type="application/ld+json" set:html={JSON.stringify(reviewSchema)} />
	
	<Navbar />
	<main>
		
		<!-- SECTION 1 — HERO -->
		<section class="pt-32 md:pt-40 pb-24 md:pb-32 px-6 md:px-12 bg-ivory dark:bg-graphite relative" aria-label="Hero - Case Study">
			<div class="max-w-5xl mx-auto text-center space-y-8 fade-in-up">
				<!-- Pill Contextuel -->
				<ContextualPill text={pillText} variant="center" marginBottom="sm" />
				<h1 class="font-serif text-4xl md:text-5xl lg:text-6xl leading-[1.1] text-balance font-medium text-graphite dark:text-ivory">
					{caseStudy.title}
				</h1>
				<p class="font-serif text-lg md:text-xl italic text-graphite dark:text-warmgray-300 max-w-3xl mx-auto leading-relaxed">
					{caseStudy.heroIntro}
				</p>
				<div class="pt-4">
					<div class="w-24 h-px bg-sand/30 dark:bg-sand/20 mx-auto"></div>
				</div>
			</div>
		</section>

		<!-- Contenu dynamique de l'étude de cas -->
		<ContentComponent />

		<!-- SECTION 7 — CTA Final -->
		<section id="contact" class="py-32 px-6 md:px-12 flex flex-col justify-center items-center text-center relative z-0 bg-ivory dark:bg-graphite-light fade-in-up" aria-labelledby="cta-heading">
			<BackgroundOverlay variant="sand" />
			<div class="max-w-3xl space-y-6 relative z-10">
				<h2 id="cta-heading" class="font-serif text-3xl md:text-4xl leading-tight text-graphite dark:text-ivory">
					Votre produit traverse un moment critique.
				</h2>
				<p class="font-serif text-lg italic opacity-80 text-graphite dark:text-warmgray-300">
					Clarifions ensemble ce qui bloque.
				</p>
				<p class="text-base text-graphite dark:text-warmgray-300">
					Un échange de 30 minutes pour comprendre votre situation et identifier les leviers immédiats.
				</p>
				<div class="flex flex-col items-center gap-6 pt-4">
					<Button 
						href="https://app.lemcal.com/@productcopilot/decouverte"
						text="Diagnostiquer votre situation"
						variant="primary"
						size="md"
						lemcal={true}
						ariaLabel="Diagnostiquer votre situation produit"
					/>
					<div class="w-16 h-0.5 bg-sand mx-auto opacity-40"></div>
				</div>
			</div>
		</section>

	</main>
	<Footer />
</Layout>

